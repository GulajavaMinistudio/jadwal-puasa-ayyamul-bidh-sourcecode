<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Tracker puasa Ayyamul Bidh dengan statistik"
    />
    <title>Tracker - Puasa Ayyamul Bidh</title>

    <!-- Bootstrap 5.3.8 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/components.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">
          <i class="bi bi-moon-stars-fill me-2"></i>
          Puasa Ayyamul Bidh
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">
                <i class="bi bi-house-fill"></i> Beranda
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="kalender.html">
                <i class="bi bi-calendar3"></i> Kalender
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="tracker.html">
                <i class="bi bi-check2-square"></i> Tracker
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="jadwal-shalat.html">
                <i class="bi bi-clock"></i> Jadwal Shalat
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="panduan.html">
                <i class="bi bi-book"></i> Panduan
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="pengaturan.html">
                <i class="bi bi-gear"></i> Pengaturan
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4">
      <div class="row">
        <div class="col-12">
          <h2 class="mb-4">
            <i class="bi bi-check2-square-fill text-success"></i>
            Tracker Puasa Ayyamul Bidh
          </h2>
        </div>
      </div>

      <!-- Current Month Tracker -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h4 class="card-title mb-4" id="currentMonthTitle">Bulan Ini</h4>
              <div id="currentMonthTracker">
                <!-- Will be populated by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-12">
          <div class="card shadow border-0 gradient-card">
            <div class="card-body">
              <h4 class="card-title mb-4">
                <i class="bi bi-graph-up-arrow text-success"></i>
                Statistik Puasa
              </h4>

              <div class="row g-3 mb-4">
                <!-- Total Tahun Ini -->
                <div class="col-md-4">
                  <div class="text-center p-3 bg-white rounded">
                    <h2 class="fw-bold mb-2" id="totalYearly">0/36</h2>
                    <p class="text-muted mb-0">Total Tahun Ini</p>
                    <div class="progress mt-2" style="height: 8px">
                      <div
                        class="progress-bar bg-success"
                        id="yearlyProgressBar"
                        style="width: 0%"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Bulan Complete -->
                <div class="col-md-4">
                  <div class="text-center p-3 bg-white rounded">
                    <h2 class="fw-bold mb-2" id="completeMonths">0/12</h2>
                    <p class="text-muted mb-0">Bulan Lengkap</p>
                  </div>
                </div>

                <!-- Streak -->
                <div class="col-md-4">
                  <div class="text-center p-3 bg-white rounded">
                    <h2 class="fw-bold mb-2">
                      <i class="bi bi-fire text-warning"></i>
                      <span id="currentStreak">0</span>
                    </h2>
                    <p class="text-muted mb-0">Streak (bulan)</p>
                  </div>
                </div>
              </div>

              <!-- Monthly Chart -->
              <div class="chart-container">
                <h5 class="mb-3">Progress Per Bulan</h5>
                <div id="monthlyChart">
                  <!-- Will be populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- History Accordion -->
      <div class="row mb-4">
        <div class="col-md-12">
          <h4 class="mb-3">
            <i class="bi bi-clock-history text-info"></i>
            Riwayat Puasa
          </h4>
          <div class="accordion" id="historyAccordion">
            <!-- Will be populated by JS -->
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">
          &copy; <span id="currentYear">2025</span> Puasa Ayyamul Bidh |
          Dikembangkan oleh
          <strong>Gulajava Ministudio</strong>
        </p>
      </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript Modules -->
    <script type="module" src="/js/main.js"></script>

    <!-- Tracker Page Script -->
    <script type="module">
      import { HijriCalendar } from "/js/hijri-calendar.js";
      import { FastingTracker } from "/js/tracker.js";
      import { Utils } from "/js/utils.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const hijriCalendar = new HijriCalendar();
        const tracker = new FastingTracker();

        let currentHijriDate = null;

        // Load current Hijri date
        async function loadCurrentHijriDate() {
          try {
            currentHijriDate = await hijriCalendar.getCurrentHijriDate();
            return currentHijriDate;
          } catch (error) {
            console.error("Error loading Hijri date:", error);
            return null;
          }
        }

        // Render current month tracker
        async function renderCurrentMonthTracker() {
          if (!currentHijriDate) return;

          const month = currentHijriDate.month;
          const year = currentHijriDate.year;
          const monthName = Utils.getHijriMonthName(month);

          document.getElementById(
            "currentMonthTitle"
          ).textContent = `${monthName} ${year} H`;

          const dates = await hijriCalendar.getAyyamulBidhDates(month, year);
          const monthStats = tracker.getMonthlyStats(month, year);

          const container = document.getElementById("currentMonthTracker");
          container.innerHTML = `
                <ul class="tracker-list">
                    ${dates
                      .map((date) => {
                        const isMarked = tracker.isFastingMarked(
                          date.hijriDay,
                          month,
                          year
                        );
                        const isPast =
                          new Date(date.gregorianDate) < new Date();

                        return `
                            <li class="tracker-item ${
                              isMarked ? "completed" : ""
                            }">
                                <input type="checkbox" 
                                       class="tracker-checkbox" 
                                       data-day="${date.hijriDay}" 
                                       data-month="${month}" 
                                       data-year="${year}"
                                       ${isMarked ? "checked" : ""}>
                                <div class="tracker-label">
                                    <strong>${
                                      date.hijriDay
                                    } ${monthName} ${year} H</strong>
                                    <br>
                                    <small class="text-muted">
                                        ${date.gregorianDate.toLocaleDateString(
                                          "id-ID",
                                          {
                                            weekday: "long",
                                            day: "numeric",
                                            month: "long",
                                            year: "numeric",
                                          }
                                        )}
                                        ${
                                          isPast && !isMarked
                                            ? " (Terlewat)"
                                            : ""
                                        }
                                    </small>
                                </div>
                                ${
                                  isMarked
                                    ? '<span class="tracker-badge">âœ“ Selesai</span>'
                                    : ""
                                }
                            </li>
                        `;
                      })
                      .join("")}
                </ul>
                
                <div class="alert ${
                  monthStats.isComplete ? "alert-success" : "alert-info"
                } mt-3">
                    <strong>Progress:</strong> ${
                      monthStats.totalDays
                    }/3 hari (${monthStats.percentage}%)
                    ${
                      monthStats.isComplete
                        ? " ðŸŽ‰ <strong>LENGKAP!</strong>"
                        : ""
                    }
                </div>
            `;

          // Add event listeners to checkboxes
          container
            .querySelectorAll(".tracker-checkbox")
            .forEach((checkbox) => {
              checkbox.addEventListener("change", (e) => {
                const day = parseInt(e.target.dataset.day);
                const month = parseInt(e.target.dataset.month);
                const year = parseInt(e.target.dataset.year);

                tracker.toggleFasting(day, month, year);
                renderAll();
              });
            });
        }

        // Render statistics
        async function renderStatistics() {
          if (!currentHijriDate) return;

          const year = currentHijriDate.year;
          const month = currentHijriDate.month;
          const yearStats = tracker.getYearlyStats(year);
          const streak = tracker.getCurrentStreak(month, year);

          // Total yearly
          document.getElementById(
            "totalYearly"
          ).textContent = `${yearStats.totalDays}/36`;
          document.getElementById(
            "yearlyProgressBar"
          ).style.width = `${yearStats.percentage}%`;

          // Complete months
          document.getElementById(
            "completeMonths"
          ).textContent = `${yearStats.completeMonths}/12`;

          // Streak
          document.getElementById("currentStreak").textContent = streak;

          // Monthly chart
          const chartContainer = document.getElementById("monthlyChart");
          chartContainer.innerHTML = yearStats.monthlyDetails
            .map(
              (monthData) => `
                <div class="chart-bar">
                    <div class="chart-label">${Utils.getHijriMonthName(
                      monthData.month
                    ).substring(0, 3)}</div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar-fill" style="width: ${
                          monthData.percentage
                        }%">
                            ${monthData.totalDays}/3
                        </div>
                    </div>
                </div>
            `
            )
            .join("");
        }

        // Render history accordion
        function renderHistory() {
          const history = tracker.getFastingHistory();
          const accordion = document.getElementById("historyAccordion");

          if (history.length === 0) {
            accordion.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="empty-state-title">Belum Ada Riwayat</div>
                        <div class="empty-state-message">Mulai tandai puasa Anda untuk melihat riwayat di sini</div>
                    </div>
                `;
            return;
          }

          accordion.innerHTML = history
            .map(
              (item, index) => `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${
                          index !== 0 ? "collapsed" : ""
                        }" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#history${index}">
                            <strong>${item.monthName} ${item.year} H</strong>
                            <span class="ms-auto me-3">
                                <span class="custom-badge ${
                                  item.status === "complete"
                                    ? "badge-complete"
                                    : item.status === "partial"
                                    ? "badge-partial"
                                    : "badge-none"
                                }">
                                    ${item.totalDays}/3 - ${
                item.status === "complete"
                  ? "Lengkap"
                  : item.status === "partial"
                  ? "Sebagian"
                  : "Kosong"
              }
                                </span>
                            </span>
                        </button>
                    </h2>
                    <div id="history${index}" class="accordion-collapse collapse ${
                index === 0 ? "show" : ""
              }" data-bs-parent="#historyAccordion">
                        <div class="accordion-body">
                            <p><strong>Hari yang sudah puasa:</strong></p>
                            <ul>
                                ${item.days
                                  .map(
                                    (day) =>
                                      `<li>Tanggal ${day} ${item.monthName} ${item.year} H</li>`
                                  )
                                  .join("")}
                            </ul>
                            ${
                              item.totalDays === 0
                                ? '<p class="text-muted">Belum ada puasa di bulan ini</p>'
                                : ""
                            }
                        </div>
                    </div>
                </div>
            `
            )
            .join("");
        }

        // Render all
        async function renderAll() {
          await renderCurrentMonthTracker();
          await renderStatistics();
          renderHistory();
        }

        // Initial load
        await loadCurrentHijriDate();
        await renderAll();
      });
    </script>
  </body>
</html>
